<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon EMR ç‰ˆæœ¬å‡çº§åŠ©æ‰‹</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 200px);
            min-height: 500px;
        }

        .messages-container {
            height: calc(100% - 120px);
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .user-message {
            background-color: #dbeafe;
            margin-left: 2rem;
        }

        .assistant-message {
            background-color: #f0fdf4;
            margin-right: 2rem;
        }

        .thinking-section {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            margin-bottom: 1rem;
        }

        .context-section {
            background-color: #f3f4f6;
            border-left: 4px solid #6b7280;
            font-size: 0.875rem;
        }

        /* åŠ¨æ€ç­‰å¾…æ•ˆæœ */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots .dot {
            animation: loading 1.4s infinite ease-in-out both;
            display: inline-block;
        }

        .loading-dots .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {

            0%,
            80%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ç­‰å¾…è¾“å‡ºå®Œæˆçš„åŠ¨æ€æ•ˆæœ */
        .waiting-effect {
            display: inline-block;
        }

        .waiting-effect .waiting-dot {
            animation: waiting 1.5s infinite ease-in-out both;
            display: inline-block;
            margin: 0 1px;
        }

        .waiting-effect .waiting-dot:nth-child(1) {
            animation-delay: -0.3s;
        }

        .waiting-effect .waiting-dot:nth-child(2) {
            animation-delay: -0.15s;
        }

        .waiting-effect .waiting-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes waiting {
            0%, 80%, 100% {
                opacity: 0.4;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-6">
            <div class="flex justify-between items-center mb-4">
                <div></div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸš€ Amazon EMR ç‰ˆæœ¬å‡çº§åŠ©æ‰‹</h1>
                    <p class="text-gray-600">åŸºäº AI çš„æ™ºèƒ½ EMR å‡çº§æŒ‡å¯¼ï¼Œå¸®æ‚¨è§£å†³ç‰ˆæœ¬å‡çº§ä¸­çš„å„ç§é—®é¢˜</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <button id="memoryStatsBtn" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                        ğŸ“Š è®°å¿†ç»Ÿè®¡
                    </button>
                    <button id="recentMemoriesBtn" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">
                        ğŸ“š å†å²è®°å¿†
                    </button>
                    <button id="clearMemoriesBtn" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                        ğŸ—‘ï¸ æ¸…é™¤è®°å¿†
                    </button>
                </div>
            </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg chat-container">
            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div id="messages" class="messages-container p-4 space-y-4">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message assistant-message">
                    <div class="flex items-start space-x-3">
                        <div
                            class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                            AI
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-green-700 mb-1">EMR å‡çº§åŠ©æ‰‹</div>
                            <div class="text-gray-700">
                                <p>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ Amazon EMR ç‰ˆæœ¬å‡çº§åŠ©æ‰‹ã€‚</p>
                                <p>æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ï¼š</p>
                                <ul class="list-disc list-inside mt-2 space-y-1">
                                    <li>äº†è§£ä¸åŒ EMR ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚</li>
                                    <li>è·å–ç»„ä»¶å…¼å®¹æ€§ä¿¡æ¯ï¼ˆHiveã€Sparkã€Flinkã€HBaseç­‰ï¼‰</li>
                                    <li>è§£å†³å‡çº§è¿‡ç¨‹ä¸­çš„æŠ€æœ¯é—®é¢˜</li>
                                    <li>æä¾›æœ€ä½³å®è·µå»ºè®®</li>
                                </ul>
                                <p class="mt-2">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š"ä» EMR 5.x å‡çº§åˆ° 6.x éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="border-t p-4">
                <div class="flex space-x-3">
                    <textarea id="messageInput"
                        class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        rows="2" placeholder="è¯·è¾“å…¥æ‚¨çš„ EMR å‡çº§ç›¸å…³é—®é¢˜..." onkeydown="handleKeyDown(event)"></textarea>
                    <button id="sendButton" onclick="sendMessage()"
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        å‘é€
                    </button>
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    æŒ‰ Enter å¿«é€Ÿå‘é€
                </div>
            </div>
        </div>

        <!-- ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨ -->
    </div>

    <script>
        let isLoading = false;

        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            if (isLoading) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            input.value = '';

            // è®¾ç½®åŠ è½½çŠ¶æ€
            isLoading = true;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'å‘é€ä¸­...';

            // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
            const assistantMessageDiv = createAssistantMessageContainer();
            // ç¡®ä¿åŠ¨ç”»å¯è§
            const loadingDots = assistantMessageDiv.querySelector('.loading-dots');
            if (loadingDots) loadingDots.style.display = 'inline-block';

            try {
                console.log('å¼€å§‹å‘é€è¯·æ±‚åˆ° /chat');
                
                // ä½¿ç”¨ fetch è¿›è¡Œæµå¼å“åº”ï¼Œç¡®ä¿ä¸ç¼“å­˜å“åº”
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Connection': 'keep-alive',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({ query: message }),
                    // å¢åŠ è¶…æ—¶è®¾ç½®
                    signal: AbortSignal.timeout(300000) // 5åˆ†é’Ÿè¶…æ—¶
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                console.log('æ”¶åˆ°å“åº”ï¼Œå¼€å§‹å¤„ç†æµæ•°æ®');

                // ä½¿ç”¨ ReadableStream API å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let accumulatedContent = '';
                let receivedDataCount = 0;

                // è®¾ç½®è¶…æ—¶å¤„ç†
                const timeout = setTimeout(() => {
                    console.warn('æµå¼å“åº”è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨å¤„ç†æ—¶é—´è¿‡é•¿');
                    const statusArea = assistantMessageDiv.querySelector('.status-area');
                    if (statusArea) {
                        statusArea.innerHTML = `<span class="text-yellow-600">âš ï¸ å“åº”æ—¶é—´è¾ƒé•¿ï¼Œæ­£åœ¨åŠªåŠ›å¤„ç†ä¸­...</span>`;
                        statusArea.style.display = 'block';
                    }
                }, 30000); // 30ç§’è¶…æ—¶
                
                try {
                    // æ·»åŠ é‡è¯•è®¡æ•°å™¨
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    while (true) {
                        try {
                            const { done, value } = await reader.read();
                            
                            if (done) {
                                console.log('æµæ•°æ®è¯»å–å®Œæˆ');
                                break;
                            }
                            
                            // é‡ç½®è¶…æ—¶è®¡æ—¶å™¨å’Œé‡è¯•è®¡æ•°å™¨
                            clearTimeout(timeout);
                            retryCount = 0;
                            
                            // è§£ç äºŒè¿›åˆ¶æ•°æ®
                            const chunk = decoder.decode(value, { stream: true });
                            console.log('æ”¶åˆ°æ•°æ®å—:', chunk);
                            buffer += chunk;
                        } catch (readError) {
                            console.error('è¯»å–æµæ•°æ®æ—¶å‡ºé”™:', readError);
                            
                            // å¦‚æœæ˜¯"Error in input stream"é”™è¯¯ï¼Œå°è¯•é‡è¯•
                            if (readError.message.includes('input stream') && retryCount < maxRetries) {
                                retryCount++;
                                console.warn(`æµè¯»å–é”™è¯¯ï¼Œæ­£åœ¨å°è¯•ç¬¬ ${retryCount} æ¬¡é‡è¯•...`);
                                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’åé‡è¯•
                                continue;
                            }
                            
                            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°æˆ–å…¶ä»–é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶ä¸­æ–­
                            const statusArea = assistantMessageDiv.querySelector('.status-area');
                            if (statusArea) {
                                statusArea.innerHTML = `<span class="text-red-600">âŒ è¯»å–å“åº”æ—¶å‡ºé”™: ${readError.message}</span>`;
                                statusArea.style.display = 'block';
                            }
                            break;
                        }
                        
                        // å¤„ç†å®Œæ•´çš„ SSE æ¶ˆæ¯ - ä¿®å¤åˆ†éš”ç¬¦é—®é¢˜
                        // SSE æ¶ˆæ¯å¯èƒ½ä½¿ç”¨ \n\n æˆ– \r\n\r\n ä½œä¸ºåˆ†éš”ç¬¦
                        const lines = buffer.split(/\r?\n\r?\n/);
                        buffer = lines.pop() || ''; // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                        
                        let hasProcessedData = false;
                        
                        for (const line of lines) {
                            if (line.trim() && line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.slice(6).trim();
                                    if (jsonStr) {
                                        const data = JSON.parse(jsonStr);
                                        receivedDataCount++;
                                        console.log(`å¤„ç†ç¬¬ ${receivedDataCount} æ¡æµæ•°æ®:`, data);
                                        
                                        // å¤„ç†æ•°æ®
                                        handleStreamData(data, assistantMessageDiv);
                                        hasProcessedData = true;
                                        
                                        // æ›´æ–°ç´¯ç§¯å†…å®¹
                                        if (data.type === 'content') {
                                            if (data.accumulated) {
                                                accumulatedContent = data.accumulated;
                                            } else if (data.content) {
                                                accumulatedContent += data.content;
                                            }
                                        }
                                        
                                        // å¦‚æœæ˜¯ç»“æŸä¿¡å·ï¼Œç»“æŸå¤„ç†
                                        if (data.type === 'end') {
                                            console.log('æ”¶åˆ°ç»“æŸä¿¡å·');
                                            clearTimeout(timeout);
                                            break;
                                        }
                                        
                                        // å¦‚æœæ˜¯é”™è¯¯ä¿¡å·ï¼Œæ˜¾ç¤ºé”™è¯¯å¹¶ç»“æŸå¤„ç†
                                        if (data.type === 'error') {
                                            console.error('æ”¶åˆ°é”™è¯¯ä¿¡å·:', data.error);
                                            clearTimeout(timeout);
                                            break;
                                        }
                                    }
                                } catch (e) {
                                    console.error('è§£ææµæ•°æ®å¤±è´¥:', e, 'åŸå§‹æ•°æ®:', line);
                                    // å°è¯•æ¢å¤å¤„ç†ï¼Œä¸ä¸­æ–­æµç¨‹
                                }
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰å¤„ç†ä»»ä½•æ•°æ®ï¼Œå¯èƒ½æ˜¯æ ¼å¼é—®é¢˜ï¼Œå°è¯•å…¶ä»–åˆ†éš”ç¬¦
                        if (!hasProcessedData && buffer.length > 5000) {
                            console.warn('é•¿æ—¶é—´æœªå¤„ç†ä»»ä½•æ•°æ®ï¼Œå°è¯•é‡æ–°è§£æç¼“å†²åŒº');
                            // å°è¯•ä½¿ç”¨å…¶ä»–åˆ†éš”ç¬¦é‡æ–°è§£æ
                            const alternativeLines = buffer.split('data: ');
                            for (const line of alternativeLines) {
                                if (line.trim()) {
                                    try {
                                        const jsonStr = line.trim();
                                        const data = JSON.parse(jsonStr);
                                        handleStreamData(data, assistantMessageDiv);
                                    } catch (e) {
                                        // å¿½ç•¥è§£æé”™è¯¯
                                    }
                                }
                            }
                            // æ¸…ç©ºç¼“å†²åŒºï¼Œé¿å…é‡å¤å¤„ç†
                            buffer = '';
                        }
                    }
                } finally {
                    clearTimeout(timeout);
                }
                
                console.log(`æµå¼å“åº”å¤„ç†å®Œæˆï¼Œå…±å¤„ç† ${receivedDataCount} æ¡æ•°æ®`);

            } catch (error) {
                console.error('æµå¼è¯·æ±‚å¤±è´¥:', error);
                const errorMsg = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
                addMessage(errorMsg, 'error');
                
                // åœ¨åŠ©æ‰‹æ¶ˆæ¯ä¸­ä¹Ÿæ˜¾ç¤ºé”™è¯¯
                const statusArea = assistantMessageDiv.querySelector('.status-area');
                const loadingDots = assistantMessageDiv.querySelector('.loading-dots');
                
                if (loadingDots) loadingDots.style.display = 'none';
                if (statusArea) {
                    statusArea.innerHTML = `<span class="text-red-600">${errorMsg}</span>`;
                    statusArea.style.display = 'block';
                }
            } finally {
                // æ¢å¤å‘é€æŒ‰é’®çŠ¶æ€
                isLoading = false;
                sendButton.disabled = false;
                sendButton.textContent = 'å‘é€';
            }
        }

        function createAssistantMessageContainer() {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';

            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold relative">
                        ğŸ¤–
                        <span class="loading-dots ml-1 text-blue-500 absolute top-0 right-0" style="display:inline-block;">
                            <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
                        </span>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-green-700 mb-1">
                            EMR å‡çº§åŠ©æ‰‹
                            <span class="waiting-effect ml-2 text-blue-500" style="display:inline-block;">
                                <span class="waiting-dot">â—</span><span class="waiting-dot">â—</span><span class="waiting-dot">â—</span>
                            </span>
                        </div>
                        <div class="status-area text-sm text-gray-600 mb-2"></div>
                        <div class="content-area text-gray-700 prose prose-sm max-w-none"></div>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageDiv;
        }

        function handleStreamData(data, messageDiv) {
            const statusArea = messageDiv.querySelector('.status-area');
            const contentArea = messageDiv.querySelector('.content-area');
            const loadingDots = messageDiv.querySelector('.loading-dots');
            const waitingEffect = messageDiv.querySelector('.waiting-effect');

            switch (data.type) {
                case 'heartbeat':
                    // å¿ƒè·³ä¿¡å·ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
                    break;

                case 'content':
                    // åªåœ¨é¦–æ¬¡å†…å®¹åˆ°æ¥æ—¶éšè— loading åŠ¨ç”»
                    if (loadingDots && loadingDots.style.display !== 'none') {
                        loadingDots.style.display = 'none';
                    }
                    statusArea.style.display = 'none';

                    // å®æ—¶æ›´æ–°å†…å®¹åŒºåŸŸ
                    let content = '';
                    if (data.accumulated) {
                        content = data.accumulated;
                    } else if (data.content) {
                        const existingContent = contentArea.getAttribute('data-raw-content') || '';
                        content = existingContent + data.content;
                    }
                    contentArea.setAttribute('data-raw-content', content);

                    // æ¸²æŸ“ Markdown
                    if (content) {
                        try {
                            if (typeof marked === 'function') {
                                contentArea.innerHTML = marked(content);
                            } else if (typeof marked.parse === 'function') {
                                contentArea.innerHTML = marked.parse(content);
                            } else {
                                throw new Error('marked åº“ä¸å¯ç”¨');
                            }
                        } catch (e) {
                            contentArea.innerHTML = content.replace(/\n/g, '<br>');
                        }
                    }
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    break;

                case 'status':
                    statusArea.innerHTML = `<span class="text-blue-600">${data.message}</span>`;
                    statusArea.style.display = 'block';
                    break;

                case 'error':
                    if (loadingDots) {
                        loadingDots.style.display = 'none';
                    }
                    if (waitingEffect) {
                        waitingEffect.style.display = 'none';
                    }
                    statusArea.innerHTML = `<span class="text-red-600">âŒ ${data.error}</span>`;
                    statusArea.style.display = 'block';
                    break;

                case 'end':
                    if (loadingDots) {
                        loadingDots.style.display = 'none';
                    }
                    if (waitingEffect) {
                        waitingEffect.style.display = 'none';
                    }
                    break;
            }
        }

        function addMessage(content, type) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');

            if (type === 'user') {
                messageDiv.className = 'message user-message';
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="flex-1 text-right">
                            <div class="font-semibold text-blue-700 mb-1">æ‚¨</div>
                            <div class="text-gray-700">${escapeHtml(content)}</div>
                        </div>
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                            U
                        </div>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.className = 'message bg-red-50 border border-red-200';
                messageDiv.innerHTML = `
                    <div class="text-red-700">${escapeHtml(content)}</div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addAssistantMessage(data) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';

            let content = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                        ğŸ¤–
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-green-700 mb-1">EMR å‡çº§åŠ©æ‰‹ (Strands Agent)</div>
            `;

            // æ·»åŠ  AI æ€è€ƒè¿‡ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.thinking && data.thinking.trim()) {
                content += `
                    <details class="mb-4">
                        <summary class="cursor-pointer text-sm text-yellow-700 hover:text-yellow-600 font-medium">
                            ğŸ§  AI æ€è€ƒè¿‡ç¨‹ (ç‚¹å‡»å±•å¼€/æŠ˜å )
                        </summary>
                        <div class="thinking-section mt-2 p-3 rounded bg-yellow-50 border-l-4 border-yellow-400">
                            <div class="text-gray-700 whitespace-pre-wrap text-sm">${escapeHtml(data.thinking)}</div>
                        </div>
                    </details>
                `;
            }

            // æ·»åŠ å·¥å…·ä½¿ç”¨æƒ…å†µï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.tools_used && data.tools_used.length > 0) {
                content += `
                    <details class="mb-4">
                        <summary class="cursor-pointer text-sm text-blue-700 hover:text-blue-600 font-medium">
                            ğŸ”§ ä½¿ç”¨çš„å·¥å…· (${data.tools_used.length} ä¸ª)
                        </summary>
                        <div class="tools-section mt-2 p-3 rounded bg-blue-50 border-l-4 border-blue-400">
                `;

                data.tools_used.forEach(tool => {
                    content += `
                        <div class="mb-2 text-sm">
                            <span class="font-medium text-blue-800">ğŸ” ${tool.name || 'search_context'}</span>
                            ${tool.description ? `<div class="text-gray-600 ml-4">${escapeHtml(tool.description)}</div>` : ''}
                        </div>
                    `;
                });

                content += `
                        </div>
                    </details>
                `;
            }

            // æ·»åŠ ä¸»è¦å›ç­”
            if (data.answer) {
                content += `
                    <div class="text-gray-700 prose prose-sm max-w-none">
                        ${marked.parse(data.answer)}
                    </div>
                `;
            }

            // æ·»åŠ çŸ¥è¯†åº“ä¸Šä¸‹æ–‡ï¼ˆæŠ˜å æ˜¾ç¤ºï¼‰
            if (data.context && data.context.trim()) {
                content += `
                    <details class="mt-4">
                        <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                            ğŸ“š æŸ¥çœ‹ç›¸å…³çŸ¥è¯†åº“å†…å®¹
                        </summary>
                        <div class="context-section mt-2 p-3 rounded bg-gray-50 border-l-4 border-gray-400">
                            <div class="text-gray-600 whitespace-pre-wrap text-sm">${escapeHtml(data.context)}</div>
                        </div>
                    </details>
                `;
            }

            content += `
                    </div>
                </div>
            `;

            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function setLoading(loading) {
            isLoading = loading;
            const loadingDiv = document.getElementById('loading');
            const sendButton = document.getElementById('sendButton');

            if (loading) {
                loadingDiv.classList.remove('hidden');
                sendButton.disabled = true;
                sendButton.textContent = 'å‘é€ä¸­...';
            } else {
                loadingDiv.classList.add('hidden');
                sendButton.disabled = false;
                sendButton.textContent = 'å‘é€';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è®°å¿†ç®¡ç†åŠŸèƒ½
        async function showMemoryStats() {
            try {
                const response = await fetch('/memory/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    let message = `ğŸ“Š è®°å¿†ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ï¼š\n\n`;
                    message += `â€¢ çŠ¶æ€: ${stats.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}\n`;
                    message += `â€¢ æ€»è®°å¿†æ•°é‡: ${stats.total_memories || 0}\n`;
                    message += `â€¢ ç”¨æˆ·ID: ${stats.user_id || 'æœªçŸ¥'}\n`;
                    message += `â€¢ OpenSearchè¿æ¥: ${stats.opensearch_connected ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}\n`;
                    
                    if (stats.earliest_memory) {
                        message += `â€¢ æœ€æ—©è®°å¿†: ${stats.earliest_memory.substring(0, 19)}\n`;
                    }
                    if (stats.latest_memory) {
                        message += `â€¢ æœ€æ–°è®°å¿†: ${stats.latest_memory.substring(0, 19)}\n`;
                    }
                    
                    alert(message);
                } else {
                    alert(`âŒ è·å–è®°å¿†ç»Ÿè®¡å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        async function showRecentMemories() {
            try {
                const response = await fetch('/memory/recent?limit=5');
                const data = await response.json();
                
                if (data.success) {
                    if (data.memories.length === 0) {
                        alert('ğŸ“š æš‚æ— å†å²è®°å¿†è®°å½•');
                        return;
                    }
                    
                    let message = `ğŸ“š æœ€è¿‘çš„ ${data.memories.length} æ¡è®°å¿†ï¼š\n\n`;
                    
                    data.memories.forEach((memory, index) => {
                        const timestamp = memory.metadata?.timestamp || 'æœªçŸ¥æ—¶é—´';
                        const memoryText = memory.memory || '';
                        const preview = memoryText.length > 100 ? 
                            memoryText.substring(0, 100) + '...' : memoryText;
                        
                        message += `${index + 1}. ${timestamp.substring(0, 19)}\n`;
                        message += `   ${preview}\n\n`;
                    });
                    
                    alert(message);
                } else {
                    alert(`âŒ è·å–å†å²è®°å¿†å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        async function clearMemories() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/memory/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… æ‰€æœ‰å†å²è®°å¿†å·²æˆåŠŸæ¸…é™¤');
                } else {
                    alert(`âŒ æ¸…é™¤è®°å¿†å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•æµå¼å“åº”åŠŸèƒ½å·²ç§»é™¤

        // é¡µé¢åŠ è½½å®Œæˆåèšç„¦è¾“å…¥æ¡†å¹¶ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('messageInput').focus();
            
            // ç»‘å®šè®°å¿†ç®¡ç†æŒ‰é’®äº‹ä»¶
            document.getElementById('memoryStatsBtn').addEventListener('click', showMemoryStats);
            document.getElementById('recentMemoriesBtn').addEventListener('click', showRecentMemories);
            document.getElementById('clearMemoriesBtn').addEventListener('click', clearMemories);
        });
    </script>
</body>

</html>